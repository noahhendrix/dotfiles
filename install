#!/bin/bash
set -e

DOTFILES_DIR="$(cd "$(dirname "$0")" && pwd)"

# ================
# Symlink dotfiles
# ================
echo "==> Symlinking dotfiles..."
dotfiles=(.zshrc .vimrc .tmux.conf .gitconfig .gemrc)
for file in "${dotfiles[@]}"; do
  src="${DOTFILES_DIR}/${file}"
  dest="${HOME}/${file}"
  if [[ -e "$dest" && ! -L "$dest" ]]; then
    echo "    Backing up existing ${dest} -> ${dest}.bak"
    mv "$dest" "${dest}.bak"
  fi
  ln -sf "$src" "$dest"
  echo "    ${file} -> ${dest}"
done

# ================
# Create expected directories
# ================
echo "==> Creating directories..."
dirs=(
  ~/.vim/backup
  ~/.vim/swap
  ~/.vim/autoload
  ~/.vim/plugged
)
for dir in "${dirs[@]}"; do
  mkdir -p "$dir"
  echo "    ${dir}"
done

# ================
# Vim plugins
# ================
if [[ ! -f ~/.vim/autoload/plug.vim ]]; then
  echo "==> Installing vim-plug..."
  curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  echo "    Run :PlugInstall in vim to install plugins"
else
  echo "==> vim-plug already installed"
fi

# ================
# Tool check
# ================
echo ""
echo "==> Checking tools..."

tools=(jq tree gh tmux fzf)
missing=()

for tool in "${tools[@]}"; do
  if command -v "$tool" &>/dev/null; then
    echo "    [ok] $tool ($(command -v "$tool"))"
  else
    echo "    [!!] $tool is not installed"
    missing+=("$tool")
  fi
done

# Check for brew on macOS
if [[ "$(uname)" == "Darwin" ]]; then
  if command -v brew &>/dev/null; then
    echo "    [ok] brew ($(command -v brew))"
  else
    echo "    [!!] brew is not installed"
    missing+=(brew)
  fi
fi

if [[ ${#missing[@]} -gt 0 ]]; then
  echo ""
  echo "Missing tools: ${missing[*]}"
  echo ""

  # Build install commands
  brew_pkgs=()
  apt_pkgs=()
  for tool in "${missing[@]}"; do
    case "$tool" in
      brew)
        # brew is special - handled separately below
        ;;
      gh)
        brew_pkgs+=(gh)
        apt_pkgs+=(gh)
        ;;
      *)
        brew_pkgs+=("$tool")
        apt_pkgs+=("$tool")
        ;;
    esac
  done

  # Offer to install
  if [[ "$(uname)" == "Darwin" ]]; then
    # macOS: install brew first if missing, then packages
    if [[ " ${missing[*]} " == *" brew "* ]]; then
      read -p "Install Homebrew? [y/N] " -n 1 -r
      echo
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      else
        echo "Skipping brew install. You can install it manually:"
        echo '  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
      fi
    fi

    if [[ ${#brew_pkgs[@]} -gt 0 ]] && command -v brew &>/dev/null; then
      read -p "Install ${brew_pkgs[*]} via brew? [y/N] " -n 1 -r
      echo
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        # gh needs a tap on older brew versions
        if [[ " ${brew_pkgs[*]} " == *" gh "* ]]; then
          brew install gh 2>/dev/null || true
        fi
        brew install "${brew_pkgs[@]}"
      else
        echo "  To install later: brew install ${brew_pkgs[*]}"
      fi
    fi
  else
    # Linux
    if [[ ${#apt_pkgs[@]} -gt 0 ]]; then
      read -p "Install ${apt_pkgs[*]} via apt-get? [y/N] " -n 1 -r
      echo
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        # gh needs the GitHub CLI apt repo
        if [[ " ${apt_pkgs[*]} " == *" gh "* ]]; then
          if ! apt-cache show gh &>/dev/null 2>&1; then
            echo "  Adding GitHub CLI apt repository..."
            (type -p wget >/dev/null || sudo apt-get install wget -y) \
              && sudo mkdir -p -m 755 /etc/apt/keyrings \
              && out=$(mktemp) && wget -nv -O"$out" https://cli.github.com/packages/githubcli-archive-keyring.gpg \
              && cat "$out" | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
              && sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
              && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
              && sudo apt-get update
          fi
        fi
        sudo apt-get install -y "${apt_pkgs[@]}"
      else
        echo "  To install later: sudo apt-get install ${apt_pkgs[*]}"
      fi
    fi
  fi
else
  echo "    All tools installed!"
fi

echo ""
echo "Done!"
